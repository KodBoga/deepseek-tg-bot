import { Telegraf } from "telegraf";
import fetch from "node-fetch";

const bot = new Telegraf(process.env.TELEGRAM_TOKEN);

// –ù–µ—Å–∫–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
const ADMIN_CHAT_IDS = process.env.ADMIN_CHAT_IDS
  .split(",")
  .map(id => id.trim());

// –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∫–æ—Ä–æ—Ç–∫–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤
function normalizeUserMessage(text) {
  const t = text.trim().toLowerCase();

  if (t === "1") return "–Ø —Ö–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏—ë–º.";
  if (t === "2") return "–Ø —Ö–æ—á—É —É–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ–± —É—Å–ª—É–≥–∞—Ö –∫–ª–∏–Ω–∏–∫–∏.";
  if (t === "3") return "–Ø —Ö–æ—á—É —É–∑–Ω–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã –∫–ª–∏–Ω–∏–∫–∏.";
  if (t === "4") return "–£ –º–µ–Ω—è –¥—Ä—É–≥–æ–π –≤–æ–ø—Ä–æ—Å.";

  if (["–¥–∞", "–∞–≥–∞", "—É–≥—É", "–∫–æ–Ω–µ—á–Ω–æ"].includes(t)) {
    return "–î–∞, –º–µ–Ω—è —ç—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç.";
  }
  if (["–Ω–µ—Ç", "–Ω–µ", "–Ω–µ–∞"].includes(t)) {
    return "–ù–µ—Ç, —ç—Ç–æ –º–µ–Ω—è –Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç.";
  }

  return text;
}

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
const userState = {};

bot.on("text", async (ctx) => {
  const chatId = ctx.chat.id;
  const raw = ctx.message.text.trim();
  const userMessage = normalizeUserMessage(raw);

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
  if (!userState[chatId]) {
    userState[chatId] = {
      context: [],
      greeted: false,
      waitingForPhone: false,
      waitingForName: false,
      date: null,
      time: null,
      clarifyCount: 0
    };
  }

  const state = userState[chatId];

  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –Ω–∞–ø–∏—Å–∞–ª –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Äî —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —É–∂–µ –±—ã–ª–æ
  const greetings = ["–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ", "–ø—Ä–∏–≤–µ—Ç", "–¥–æ–±—Ä—ã–π –¥–µ–Ω—å", "–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä", "–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ"];
  if (greetings.includes(raw.toLowerCase())) {
    state.greeted = true;
  }

  // –ü–µ—Ä–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Äî —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
  if (!state.greeted) {
    state.greeted = true;
    return ctx.reply("–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –í–∞—Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è ¬´–ú–µ–¥–ì–∞—Ä–∞–Ω—Ç¬ª. –ü–æ–¥—Å–∫–∞–∂–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —á—Ç–æ –≤–∞—Å –±–µ—Å–ø–æ–∫–æ–∏—Ç?");
  }

  // –ï—Å–ª–∏ –∂–¥—ë–º —Ç–µ–ª–µ—Ñ–æ–Ω
  if (state.waitingForPhone) {
    const phone = raw;

    if (!phone.match(/^\+?\d[\d\s\-]{5,}$/)) {
      return ctx.reply("–ü–æ—Ö–æ–∂–µ, –Ω–æ–º–µ—Ä –≤ –Ω–µ–æ–±—ã—á–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ. –ù–∞–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –µ—â—ë —Ä–∞–∑.");
    }

    state.phone = phone;
    state.waitingForPhone = false;
    state.waitingForName = true;

    return ctx.reply("–°–ø–∞—Å–∏–±–æ! –ù–∞–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–∞—à–µ –∏–º—è –ø–æ–ª–Ω–æ—Å—Ç—å—é (–§–ò–û).");
  }

  // –ï—Å–ª–∏ –∂–¥—ë–º –∏–º—è
  if (state.waitingForName) {
    const name = raw;
    state.name = name;
    state.waitingForName = false;

    // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞—è–≤–∫—É
    const leadText = `
–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –∏–∑ –±–æ—Ç–∞:
–ò–º—è: ${state.name}
–¢–µ–ª–µ—Ñ–æ–Ω: ${state.phone}
–î–∞—Ç–∞: ${state.date ?? "–Ω–µ —É–∫–∞–∑–∞–Ω–∞"}
–í—Ä–µ–º—è: ${state.time ?? "–Ω–µ —É–∫–∞–∑–∞–Ω–æ"}
–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${state.context.join(" ")}
    `.trim();

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º
    for (const adminId of ADMIN_CHAT_IDS) {
      await ctx.telegram.sendMessage(adminId, leadText);
    }

    // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    userState[chatId] = null;

    return ctx.reply("–°–ø–∞—Å–∏–±–æ! –Ø –ø–µ—Ä–µ–¥–∞–ª –≤–∞—à—É –∑–∞—è–≤–∫—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É. –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.");
  }

  // –ü–æ–ø—ã—Ç–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
  const dateRegex = /\b(—Å–µ–≥–æ–¥–Ω—è|–∑–∞–≤—Ç—Ä–∞|\d{1,2}\.\d{1,2}|\d{1,2}\s+[–∞-—è]+)\b/i;
  const timeRegex = /\b(\d{1,2}[:.]?\d{0,2}\s*(—É—Ç—Ä–∞|–≤–µ—á–µ—Ä–∞|–¥–Ω—è)?|\b—É—Ç—Ä–æ–º\b|\b–¥–Ω—ë–º\b|\b–≤–µ—á–µ—Ä–æ–º\b)\b/i;

  const foundDate = raw.match(dateRegex);
  const foundTime = raw.match(timeRegex);

  if (foundDate && !state.date) {
    state.date = foundDate[0];
  }

  if (foundTime && !state.time) {
    state.time = foundTime[0];
  }

  // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
  state.context.push(raw);

  try {
    const response = await fetch("https://api.deepseek.com/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${process.env.DEEPSEEK_API_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: "deepseek-chat",
        messages: [
          {
            role: "system",
            content: `
–¢—ã ‚Äî –≤–µ–∂–ª–∏–≤—ã–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏–∏ ¬´–ú–µ–¥–ì–∞—Ä–∞–Ω—Ç¬ª.
–¢—ã –ù–ï –≤—Ä–∞—á. –ù–µ –¥–∞–≤–∞–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π. –ù–µ –∑–∞–¥–∞–≤–∞–π –¥–ª–∏–Ω–Ω—ã—Ö –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –º—è–≥–∫–æ —É—Ç–æ—á–Ω–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É (–Ω–µ –±–æ–ª–µ–µ 3 —Ä–∞–∑), –∞ –∑–∞—Ç–µ–º –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–µ—Ä–≤–∏—á–Ω—ã–π –ø—Ä–∏—ë–º –∏ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø—Ä–æ –∞–∫—Ü–∏—é.

–ü–†–ò–í–ï–¢–°–¢–í–ò–ï:
‚Äî –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑.
‚Äî –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –Ω–∞–ø–∏—Å–∞–ª –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Äî –æ—Ç–≤–µ—Ç—å, –Ω–æ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑.
‚Äî –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ.

–û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï –£–¢–û–ß–ù–ï–ù–ò–ô:
‚Äî –ú–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –º–∞–∫—Å–∏–º—É–º 3 –∫–æ—Ä–æ—Ç–∫–∏—Ö —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞.
‚Äî –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–µ—Ä–≤–∏—á–Ω—ã–π –ø—Ä–∏—ë–º –∏ —Ä–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –∞–∫—Ü–∏—é.

–ê–ö–¶–ò–Ø:
¬´–°–µ–π—á–∞—Å –¥–µ–π—Å—Ç–≤—É–µ—Ç –∞–∫—Ü–∏—è: –ø–æ–ª–Ω—ã–π —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π check‚Äëup ‚Äî 3500 —Ä—É–±. –≤–º–µ—Å—Ç–æ 4900 —Ä—É–±.
–í —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤—Ö–æ–¥–∏—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ª—é–±–æ–≥–æ –≤—Ä–∞—á–∞‚Äë—Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∞ –∏ –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–∞—è 3D‚Äë–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–ö–õ–ö–¢).¬ª

–õ–û–ì–ò–ö–ê:
1. –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ (–æ–¥–∏–Ω —Ä–∞–∑).
2. 1‚Äì3 –∫–æ—Ä–æ—Ç–∫–∏—Ö —É—Ç–æ—á–Ω–µ–Ω–∏—è.
3. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –ø—Ä–∏—ë–º–∞ + –∞–∫—Ü–∏—è.
4. –£—Ç–æ—á–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã.
5. –£—Ç–æ—á–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏.
6. –ó–∞–ø—Ä–æ—Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
7. –ó–∞–ø—Ä–æ—Å –∏–º–µ–Ω–∏.
8. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ.
            `.trim()
          },
          {
            role: "user",
            content: userMessage
          },
          {
            role: "assistant",
            content: `
–¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
–î–∞—Ç–∞: ${state.date ?? "–Ω–µ —É–∫–∞–∑–∞–Ω–∞"}
–í—Ä–µ–º—è: ${state.time ?? "–Ω–µ —É–∫–∞–∑–∞–Ω–∞"}
–£—Ç–æ—á–Ω–µ–Ω–∏–π: ${state.clarifyCount}
            `.trim()
          }
        ]
      })
    });

    const data = await response.json();
    let reply =
      data?.choices?.[0]?.message?.content ??
      "–ò–∑–≤–∏–Ω–∏—Ç–µ, —Å–µ–π—á–∞—Å –Ω–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å.";

    // üî• –§–ò–õ–¨–¢–† –ü–†–ò–í–ï–¢–°–¢–í–ò–ô
    reply = reply
      .replace(/^–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ[!. ]*/i, "")
      .replace(/^–¥–æ–±—Ä—ã–π –¥–µ–Ω—å[!. ]*/i, "")
      .replace(/^–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä[!. ]*/i, "")
      .replace(/^–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ[!. ]*/i, "")
      .replace(/–≤–∞—Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è ¬´?–º–µ–¥–≥–∞—Ä–∞–Ω—Ç¬ª?/gi, "")
      .replace(/–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ[!. ]*/gi, "")
      .replace(/–¥–æ–±—Ä—ã–π –¥–µ–Ω—å[!. ]*/gi, "")
      .replace(/–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä[!. ]*/gi, "")
      .replace(/–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ[!. ]*/gi, "")
      .trim();

    // üî• –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –£–¢–û–ß–ù–Ø–Æ–©–ï–ì–û –í–û–ü–†–û–°–ê (–≤–∞—Ä–∏–∞–Ω—Ç –ê)
    const clarifyPatterns = [
      /—É—Ç–æ—á–Ω–∏—Ç–µ/i,
      /–ø–æ–¥—Ä–æ–±–Ω–µ–µ/i,
      /—á—Ç–æ –∏–º–µ–Ω–Ω–æ/i,
      /–∫–∞–∫–æ–π/i,
      /–∫–∞–∫–∞—è/i,
      /–æ–ø–∏—à–∏—Ç–µ/i,
      /—Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ/i,
      /—á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç/i,
      /—á—Ç–æ –±–µ—Å–ø–æ–∫–æ–∏—Ç/i,
      /–∫–∞–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞/i,
      /–∫–∞–∫–æ–π –∑—É–±/i,
      /—á—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å/i
    ];

    if (clarifyPatterns.some(p => reply.match(p))) {
      state.clarifyCount++;
    }

    // üî• –ï–°–õ–ò –£–¢–û–ß–ù–ï–ù–ò–ô >= 3 ‚Üí –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï –ü–†–ò–Å–ú–ê + –ê–ö–¶–ò–Ø
    if (state.clarifyCount >= 3) {
      reply =
        "–ü–æ–Ω–∏–º–∞—é, —á—Ç–æ —Å–∏—Ç—É–∞—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø—Ä–∏—è—Ç–Ω–æ–π. –ß—Ç–æ–±—ã –≤—Ä–∞—á —Ç–æ—á–Ω–æ –æ—Ü–µ–Ω–∏–ª, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –ª—É—á—à–µ –ø—Ä–∏–π—Ç–∏ –Ω–∞ –ø–µ—Ä–≤–∏—á–Ω—ã–π –ø—Ä–∏—ë–º.\n\n" +
        "–°–µ–π—á–∞—Å –¥–µ–π—Å—Ç–≤—É–µ—Ç –∞–∫—Ü–∏—è: –ø–æ–ª–Ω—ã–π —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π check‚Äëup ‚Äî 3500 —Ä—É–±. –≤–º–µ—Å—Ç–æ 4900 —Ä—É–±.\n" +
        "–í —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤—Ö–æ–¥–∏—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ª—é–±–æ–≥–æ –≤—Ä–∞—á–∞‚Äë—Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∞ –∏ –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–∞—è 3D‚Äë–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–ö–õ–ö–¢).\n\n" +
        "–ü–æ–¥—Å–∫–∞–∂–∏—Ç–µ, –∫–æ–≥–¥–∞ –≤–∞–º —É–¥–æ–±–Ω–µ–µ ‚Äî —Å–µ–≥–æ–¥–Ω—è, –∑–∞–≤—Ç—Ä–∞ –∏–ª–∏ –≤ –¥—Ä—É–≥–æ–π –¥–µ–Ω—å?";
      state.clarifyCount = 0;
    }

    // –ï—Å–ª–∏ –ø–æ—Ä–∞ —Å–æ–±–∏—Ä–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω
    if (
      reply.toLowerCase().includes("–Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞") ||
      (state.date && state.time && !state.phone)
    ) {
      state.waitingForPhone = true;
    }

    await ctx.reply(reply);
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞:", err);
    await ctx.reply("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
  }
});

bot.launch();
