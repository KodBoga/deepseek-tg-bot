import { Telegraf } from "telegraf";
import axios from "axios";

const bot = new Telegraf(process.env.BOT_TOKEN);

// Хранилище состояний пользователей
const userState = {};

function getState(id) {
  if (!userState[id]) {
    userState[id] = {
      greeted: false,
      stage: "start",
      problem: null,
      date: null,
      time: null,
      phone: null,
      name: null,
    };
  }
  return userState[id];
}

// SYSTEM PROMPT
const SYSTEM_PROMPT = `
Ты — вежливый и профессиональный администратор стоматологии «МедГарант».
Твоя задача — вести диалог с клиентом, помогать ему и собирать данные для записи.

ОБЩИЕ ПРАВИЛА:
1. Никогда не придумывай данные, которые клиент не говорил. Особенно дату, время, имя, телефон.
2. Никогда не повторяй приветствие, если диалог уже идёт.
3. Не будь фамильярным. Используй нейтрально‑вежливый стиль.
4. Не назначай точное время приёма. Клиент указывает только примерный диапазон, а точное время назначает администратор по телефону.
5. Не используй слова «дружище», «дорогой», «солнышко» и т.п.
6. Не переходи к запросу телефона, пока не уточнены:
   — проблема
   — примерная дата
   — примерное время
7. Если клиент пишет что‑то непонятное на этапе запроса телефона — вежливо попроси номер ещё раз.
8. Если клиент спрашивает цену — не называй стоимость лечения. Предлагай прийти на первичный приём и рассказывай про акцию.

АКЦИЯ:
При вопросах о цене или стоимости всегда отвечай:
«Стоимость зависит от конкретной ситуации. Чтобы врач точно сказал цену, лучше прийти на первичный приём.
Сейчас действует акция: Полный стоматологический check‑up — 3500 руб. вместо 4900 руб.
В стоимость входит консультация любого врача‑стоматолога и компьютерная 3D‑диагностика (КЛКТ).»

ЛОГИКА ДИАЛОГА:
1. Приветствие (только один раз за диалог).
2. Уточнение проблемы: что беспокоит?
3. Уточнение примерной даты: когда ориентировочно удобно — сегодня, завтра или в другой день?
4. Уточнение примерного времени: утром, днём или вечером?
5. Сообщение: «Хорошо, я зафиксировал. Администратор перезвонит и предложит точное время.»
6. Запрос телефона.
7. Запрос имени.
8. Завершение: «Спасибо! Я передал вашу заявку администратору. Мы свяжемся с вами в ближайшее время.»

ОТВЕТЫ НА СЛОЖНЫЕ СИТУАЦИИ:
— Если клиент пишет одно слово («да», «нет», «узнать», «кариес») — задавай уточняющий вопрос.
— Если клиент сбивается — мягко возвращай к текущему этапу.
— Если клиент пишет «прочти» или «мы уже говорили» — не сбрасывай контекст, продолжай с последнего этапа.
— Если клиент пишет что‑то не по теме — мягко возвращай к цели: запись на приём.

ТЫ НИКОГДА НЕ ДОЛЖЕН:
— придумывать дату или время;
— менять дату, которую сказал клиент;
— назначать точное время;
— писать «записываю вас»;
— повторять приветствие;
— быть фамильярным;
— отвечать грубо или сухо.
`;

async function askLLM(prompt) {
  const response = await axios.post(
    "https://api.deepseek.com/chat/completions",
    {
      model: "deepseek-chat",
      messages: [
        { role: "system", content: SYSTEM_PROMPT },
        { role: "user", content: prompt },
      ],
      temperature: 0.3,
    },
    {
      headers: {
        Authorization: `Bearer ${process.env.DEEPSEEK_API_KEY}`,
        "Content-Type": "application/json",
      },
    }
  );

  return response.data.choices[0].message.content;
}

bot.on("text", async (ctx) => {
  const id = ctx.from.id;
  const text = ctx.message.text.trim();
  const state = getState(id);

  // Приветствие только один раз
  if (!state.greeted) {
    state.greeted = true;
    state.stage = "problem";
    return ctx.reply("Здравствуйте! Чем могу помочь?");
  }

  // Логика этапов
  if (state.stage === "problem") {
    state.problem = text;
    state.stage = "date";
    return ctx.reply("Когда ориентировочно вам удобно — сегодня, завтра или в другой день?");
  }

  if (state.stage === "date") {
    state.date = text;
    state.stage = "time";
    return ctx.reply("В какое время ориентируетесь — утром, днём или вечером?");
  }

  if (state.stage === "time") {
    state.time = text;
    state.stage = "phone";
    return ctx.reply("Хорошо, я зафиксировал. Администратор перезвонит и предложит точное время. Напишите, пожалуйста, ваш номер телефона.");
  }

  if (state.stage === "phone") {
    if (!/^\d{10,15}$/.test(text)) {
      return ctx.reply("Пожалуйста, укажите номер телефона в формате 79991234567.");
    }
    state.phone = text;
    state.stage = "name";
    return ctx.reply("Спасибо! Напишите, пожалуйста, ваше имя.");
  }

  if (state.stage === "name") {
    state.name = text;
    state.stage = "done";

    // Отправка заявки админу
    const adminMessage = `
Новая заявка из бота:
Имя: ${state.name}
Телефон: ${state.phone}
Комментарий: ${state.problem}
Дата: ${state.date}
Время: ${state.time}
    `;

    await ctx.telegram.sendMessage(process.env.ADMIN_CHAT_ID, adminMessage);

    return ctx.reply("Спасибо! Я передал вашу заявку администратору. Мы свяжемся с вами в ближайшее время.");
  }

  // Если диалог завершён, но человек пишет снова
  return ctx.reply("Если хотите начать новую запись, просто напишите любое сообщение.");
});

bot.launch();
