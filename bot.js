import { Telegraf, Markup } from "telegraf";

const bot = new Telegraf(process.env.TELEGRAM_TOKEN);
const ADMIN_CHAT_IDS = (process.env.ADMIN_CHAT_IDS || "")
  .split(",")
  .map(id => id.trim())
  .filter(Boolean);

const userState = {};

const branches = {
  "–°–ü–±, —É–ª. –ë–∞–¥–∞–µ–≤–∞, –¥. 6, –∫–æ—Ä–ø.1":
    "–°–ü–±, —É–ª. –ë–∞–¥–∞–µ–≤–∞, –¥. 6, –∫–æ—Ä–ø.1\n–º. –ü—Ä–æ—Å–ø–µ–∫—Ç –ë–æ–ª—å—à–µ–≤–∏–∫–æ–≤\n+7 (812) 240‚Äë12‚Äë22\n9:00‚Äî21:00 (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ)",
  "–°–ü–±, —É–ª. –¢—É—Ä–∏—Å—Ç—Å–∫–∞—è, –¥. 10, –∫–æ—Ä–ø. 1":
    "–°–ü–±, —É–ª. –¢—É—Ä–∏—Å—Ç—Å–∫–∞—è, –¥. 10, –∫–æ—Ä–ø. 1\n–º. –ë–µ–≥–æ–≤–∞—è\n+7 (812) 240‚Äë12‚Äë22\n9:00‚Äî21:00 (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ)",
  "–°–ü–±, –ü–µ—Ç—Ä–æ–≤—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç, –¥. 5":
    "–°–ü–±, –ü–µ—Ç—Ä–æ–≤—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç, –¥. 5\n–º. –°–ø–æ—Ä—Ç–∏–≤–Ω–∞—è\n+7 (812) 240‚Äë12‚Äë22\n9:00‚Äî21:00 (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ)",
  "–°–ü–±, —É–ª. –ö–∏–µ–≤—Å–∫–∞—è, –¥. 3–ê":
    "–°–ü–±, —É–ª. –ö–∏–µ–≤—Å–∫–∞—è, –¥. 3–ê\n–º. –§—Ä—É–Ω–∑–µ–Ω—Å–∫–∞—è\n+7 (812) 240‚Äë12‚Äë22\n9:00‚Äî21:00 (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ)",
  "–≥. –ú—É—Ä–∏–Ω–æ, –±-—Ä –ú–µ–Ω–¥–µ–ª–µ–µ–≤–∞, –¥. 9, –∫–æ—Ä–ø.1":
    "–≥. –ú—É—Ä–∏–Ω–æ, –±-—Ä –ú–µ–Ω–¥–µ–ª–µ–µ–≤–∞, –¥. 9, –∫–æ—Ä–ø.1\n–º. –î–µ–≤—è—Ç–∫–∏–Ω–æ\n+7 (812) 240‚Äë12‚Äë22\n9:00‚Äî21:00 (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ)"
};

function mainMenu() {
  return Markup.keyboard([
    ["–ó—É–±", "–î–µ—Å–Ω–∞"],
    ["–ë—Ä–µ–∫–µ—Ç—ã", "–ì–∏–≥–∏–µ–Ω–∞"],
    ["–•–æ—á—É –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é"],
    ["–ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã"]
  ]).resize();
}

function branchesMenu() {
  return Markup.keyboard([
    [
      "–°–ü–±, —É–ª. –ë–∞–¥–∞–µ–≤–∞, –¥. 6, –∫–æ—Ä–ø.1",
      "–°–ü–±, —É–ª. –¢—É—Ä–∏—Å—Ç—Å–∫–∞—è, –¥. 10, –∫–æ—Ä–ø. 1"
    ],
    [
      "–°–ü–±, –ü–µ—Ç—Ä–æ–≤—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç, –¥. 5",
      "–°–ü–±, —É–ª. –ö–∏–µ–≤—Å–∫–∞—è, –¥. 3–ê"
    ],
    [
      "–≥. –ú—É—Ä–∏–Ω–æ, –±-—Ä –ú–µ–Ω–¥–µ–ª–µ–µ–≤–∞, –¥. 9, –∫–æ—Ä–ø.1",
      "–ù–∞–∑–∞–¥"
    ]
  ]).resize();
}

function createState() {
  return {
    section: null,
    context: [],
    invited: false,
    waitingForPhone: false,
    waitingForName: false,
    phone: null,
    name: null
  };
}

function resetState(state) {
  state.section = null;
  state.context = [];
  state.invited = false;
  state.waitingForPhone = false;
  state.waitingForName = false;
  state.phone = null;
  state.name = null;
}

bot.start((ctx) => {
  const chatId = ctx.chat.id;
  userState[chatId] = createState();

  ctx.reply(
    "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –í–∞—Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è ¬´–ú–µ–¥–ì–∞—Ä–∞–Ω—Ç¬ª. –ü–æ–¥—Å–∫–∞–∂–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —á—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç.",
    mainMenu()
  );
});

bot.on("text", async (ctx) => {
  const chatId = ctx.chat.id;
  const raw = ctx.message.text.trim();

  if (!userState[chatId]) userState[chatId] = createState();
  const state = userState[chatId];

  // –ù–∞–∑–∞–¥
  if (raw === "–ù–∞–∑–∞–¥") {
    resetState(state);
    return ctx.reply("–í–æ–∑–≤—Ä–∞—â–∞—é—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.", mainMenu());
  }

  // –ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã
  if (raw === "–ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã") {
    resetState(state);
    state.section = "branches";
    return ctx.reply("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª–∏–∞–ª:", branchesMenu());
  }

  // –í—ã–±–æ—Ä —Ñ–∏–ª–∏–∞–ª–∞
  if (state.section === "branches" && branches[raw]) {
    return ctx.reply(branches[raw]);
  }

  // –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
  if (["–ó—É–±", "–î–µ—Å–Ω–∞", "–ë—Ä–µ–∫–µ—Ç—ã", "–ì–∏–≥–∏–µ–Ω–∞", "–•–æ—á—É –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é"].includes(raw)) {
    resetState(state);
    state.section = raw;

    if (raw === "–ó—É–±")
      return ctx.reply("–ß—Ç–æ –∏–º–µ–Ω–Ω–æ –±–µ—Å–ø–æ–∫–æ–∏—Ç –∑—É–±? –ë–æ–ª—å, —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —Å–∫–æ–ª, –∫–∞—Ä–∏–µ—Å?");

    if (raw === "–î–µ—Å–Ω–∞")
      return ctx.reply("–ß—Ç–æ –∏–º–µ–Ω–Ω–æ —Å –¥–µ—Å–Ω–æ–π? –ö—Ä–æ–≤–æ—Ç–æ—á–∏—Ç, –æ–ø—É—Ö–ª–∞, –±–æ–ª–∏—Ç, –∑–∞–ø–∞—Ö?");

    if (raw === "–ë—Ä–µ–∫–µ—Ç—ã")
      return ctx.reply("–ò–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –±—Ä–µ–∫–µ—Ç–æ–≤, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –æ—Ä—Ç–æ–¥–æ–Ω—Ç–∞ –∏–ª–∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å?");

    if (raw === "–ì–∏–≥–∏–µ–Ω–∞")
      return ctx.reply("–ì–∏–≥–∏–µ–Ω–∞: –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –ø—Ä–æ—Ñ—á–∏—Å—Ç–∫–∞, AirFlow, —É–¥–∞–ª–µ–Ω–∏–µ –∫–∞–º–Ω–µ–π?");

    if (raw === "–•–æ—á—É –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é") {
      state.section = "consultation";
      return ctx.reply("–•–æ—Ä–æ—à–æ, –ø–æ–¥—Å–∫–∞–∂–∏—Ç–µ, –ø–æ –∫–∞–∫–æ–º—É –≤–æ–ø—Ä–æ—Å—É –Ω—É–∂–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è?");
    }
  }

  // –ö–Ω–æ–ø–∫–∞ "–ê–∫—Ü–∏—è"
  if (raw === "–ê–∫—Ü–∏—è") {
    return ctx.replyWithPhoto(
      {
        url: "https://avatars.mds.yandex.net/get-sprav-posts/19677858/2a0000019c4b7865802b28005b2a12f07abb/XL"
      },
      {
        caption:
          "üî• –ê–ö–¶–ò–Ø\n\n" +
          "–ü–æ–ª–Ω—ã–π —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π check‚Äëup ‚Äî 3500 —Ä—É–±. –≤–º–µ—Å—Ç–æ 4900 —Ä—É–±.\n" +
          "–í —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤—Ö–æ–¥–∏—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –∏ 3D‚Äë–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞.\n\n" +
          "–ö–æ–≥–¥–∞ –≤–∞–º —É–¥–æ–±–Ω–µ–µ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è?",
        reply_markup: {
          keyboard: [
            ["–°–µ–≥–æ–¥–Ω—è", "–ó–∞–≤—Ç—Ä–∞", "–î—Ä—É–≥–æ–π –¥–µ–Ω—å"],
            ["–ù–∞–∑–∞–¥"]
          ],
          resize_keyboard: true
        }
      }
    );
  }

  // –í—ã–±–æ—Ä –¥–Ω—è
  if (["–°–µ–≥–æ–¥–Ω—è", "–ó–∞–≤—Ç—Ä–∞", "–î—Ä—É–≥–æ–π –¥–µ–Ω—å"].includes(raw)) {
    state.context.push("–í—ã–±–æ—Ä –¥–Ω—è: " + raw);
    state.waitingForPhone = true;
    return ctx.reply("–ß—Ç–æ–±—ã –∑–∞–ø–∏—Å–∞—Ç—å –≤–∞—Å –Ω–∞ –ø—Ä–∏—ë–º, –Ω–∞–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è —Å–≤—è–∑–∏.");
  }

  // –û–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
  if (state.waitingForPhone) {
    if (!raw.match(/^\+?\d[\d\s\-]{5,}$/)) {
      return ctx.reply("–ü–æ—Ö–æ–∂–µ, –Ω–æ–º–µ—Ä –≤ –Ω–µ–æ–±—ã—á–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ. –ù–∞–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –µ—â—ë —Ä–∞–∑.");
    }

    state.phone = raw;
    state.waitingForPhone = false;
    state.waitingForName = true;

    return ctx.reply("–°–ø–∞—Å–∏–±–æ! –ù–∞–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–∞—à–µ –∏–º—è –ø–æ–ª–Ω–æ—Å—Ç—å—é (–§–ò–û).");
  }

  // –û–∂–∏–¥–∞–Ω–∏–µ –∏–º–µ–Ω–∏
  if (state.waitingForName) {
    state.name = raw;
    state.waitingForName = false;

    const lead = {
      name: state.name,
      phone: state.phone,
      comment: state.context.join(" ")
    };

    for (const adminId of ADMIN_CHAT_IDS) {
      await ctx.telegram.sendMessage(
        adminId,
        `
–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –∏–∑ –±–æ—Ç–∞:
–ò–º—è: ${lead.name}
–¢–µ–ª–µ—Ñ–æ–Ω: ${lead.phone}
–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${lead.comment}
        `.trim()
      );
    }

    delete userState[chatId];

    return ctx.reply("–°–ø–∞—Å–∏–±–æ! –Ø –ø–µ—Ä–µ–¥–∞–ª –≤–∞—à—É –∑–∞—è–≤–∫—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É. –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.");
  }

  // –ö–æ–ø–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
  state.context.push(raw);

  // –ï–¥–∏–Ω—ã–π —à–∞–≥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –Ω–∞ –ø—Ä–∏—ë–º
  if (!state.invited) {
    state.invited = true;

    return ctx.reply(
      "–ü–æ–Ω–∏–º–∞—é. –ß—Ç–æ–±—ã –≤—Ä–∞—á —Ç–æ—á–Ω–æ –æ—Ü–µ–Ω–∏–ª —Å–∏—Ç—É–∞—Ü–∏—é, –ª—É—á—à–µ –ø—Ä–∏–π—Ç–∏ –Ω–∞ –ø–µ—Ä–≤–∏—á–Ω—ã–π –ø—Ä–∏—ë–º.\n\n" +
      "–°–µ–π—á–∞—Å –¥–µ–π—Å—Ç–≤—É–µ—Ç –∞–∫—Ü–∏—è –Ω–∞ –ø–æ–ª–Ω—ã–π —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π check‚Äëup.\n" +
      "–ö–æ–≥–¥–∞ –≤–∞–º —É–¥–æ–±–Ω–µ–µ ‚Äî —Å–µ–≥–æ–¥–Ω—è, –∑–∞–≤—Ç—Ä–∞ –∏–ª–∏ –≤ –¥—Ä—É–≥–æ–π –¥–µ–Ω—å?",
      Markup.keyboard([
        ["–°–µ–≥–æ–¥–Ω—è", "–ó–∞–≤—Ç—Ä–∞", "–î—Ä—É–≥–æ–π –¥–µ–Ω—å"],
        ["–ê–∫—Ü–∏—è"],
        ["–ù–∞–∑–∞–¥"]
      ]).resize()
    );
  }

  // –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –∫–Ω–æ–ø–∫–∏
  state.waitingForPhone = true;
  return ctx.reply("–ß—Ç–æ–±—ã –∑–∞–ø–∏—Å–∞—Ç—å –≤–∞—Å –Ω–∞ –ø—Ä–∏—ë–º, –Ω–∞–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è —Å–≤—è–∑–∏.");
});

bot.launch();
