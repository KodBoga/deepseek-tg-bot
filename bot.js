import { Telegraf } from "telegraf";
import fetch from "node-fetch";

const bot = new Telegraf(process.env.TELEGRAM_TOKEN);

// –ù–µ—Å–∫–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
const ADMIN_CHAT_IDS = process.env.ADMIN_CHAT_IDS
  .split(",")
  .map(id => id.trim());

// –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∫–æ—Ä–æ—Ç–∫–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤
function normalizeUserMessage(text) {
  const t = text.trim().toLowerCase();

  if (t === "1") return "–Ø —Ö–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏—ë–º.";
  if (t === "2") return "–Ø —Ö–æ—á—É —É–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ–± —É—Å–ª—É–≥–∞—Ö –∫–ª–∏–Ω–∏–∫–∏.";
  if (t === "3") return "–Ø —Ö–æ—á—É —É–∑–Ω–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã –∫–ª–∏–Ω–∏–∫–∏.";
  if (t === "4") return "–£ –º–µ–Ω—è –¥—Ä—É–≥–æ–π –≤–æ–ø—Ä–æ—Å.";

  if (["–¥–∞", "–∞–≥–∞", "—É–≥—É", "–∫–æ–Ω–µ—á–Ω–æ"].includes(t)) {
    return "–î–∞, –º–µ–Ω—è —ç—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç.";
  }
  if (["–Ω–µ—Ç", "–Ω–µ", "–Ω–µ–∞"].includes(t)) {
    return "–ù–µ—Ç, —ç—Ç–æ –º–µ–Ω—è –Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç.";
  }

  return text;
}

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
const userState = {};

bot.on("text", async (ctx) => {
  const chatId = ctx.chat.id;
  const raw = ctx.message.text.trim();
  const userMessage = normalizeUserMessage(raw);

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
  if (!userState[chatId]) {
    userState[chatId] = {
      context: [],
      greeted: false,
      waitingForPhone: false,
      waitingForName: false,
      date: null,
      time: null,
      clarifyCount: 0
    };
  }

  const state = userState[chatId];

  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –Ω–∞–ø–∏—Å–∞–ª –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Äî —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —É–∂–µ –±—ã–ª–æ
  const greetings = ["–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ", "–ø—Ä–∏–≤–µ—Ç", "–¥–æ–±—Ä—ã–π –¥–µ–Ω—å", "–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä", "–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ"];
  if (greetings.includes(raw.toLowerCase())) {
    state.greeted = true;
  }

  // –ü–µ—Ä–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Äî —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
  if (!state.greeted) {
    state.greeted = true;
    return ctx.reply("–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –í–∞—Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è ¬´–ú–µ–¥–ì–∞—Ä–∞–Ω—Ç¬ª. –ü–æ–¥—Å–∫–∞–∂–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —á—Ç–æ –≤–∞—Å –±–µ—Å–ø–æ–∫–æ–∏—Ç?");
  }

  // –ï—Å–ª–∏ –∂–¥—ë–º —Ç–µ–ª–µ—Ñ–æ–Ω
  if (state.waitingForPhone) {
    const phone = raw;

    if (!phone.match(/^\+?\d[\d\s\-]{5,}$/)) {
      return ctx.reply("–ü–æ—Ö–æ–∂–µ, –Ω–æ–º–µ—Ä –≤ –Ω–µ–æ–±—ã—á–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ. –ù–∞–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –µ—â—ë —Ä–∞–∑.");
    }

    state.phone = phone;
    state.waitingForPhone = false;
    state.waitingForName = true;

    return ctx.reply("–°–ø–∞—Å–∏–±–æ! –ù–∞–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–∞—à–µ –∏–º—è –ø–æ–ª–Ω–æ—Å—Ç—å—é (–§–ò–û).");
  }

  // –ï—Å–ª–∏ –∂–¥—ë–º –∏–º—è
  if (state.waitingForName) {
    const name = raw;
    state.name = name;
    state.waitingForName = false;

    // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞—è–≤–∫—É
    const leadText = `
–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –∏–∑ –±–æ—Ç–∞:
–ò–º—è: ${state.name}
–¢–µ–ª–µ—Ñ–æ–Ω: ${state.phone}
–î–∞—Ç–∞: ${state.date ?? "–Ω–µ —É–∫–∞–∑–∞–Ω–∞"}
–í—Ä–µ–º—è: ${state.time ?? "–Ω–µ —É–∫–∞–∑–∞–Ω–æ"}
–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${state.context.join(" ")}
    `.trim();

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º
    for (const adminId of ADMIN_CHAT_IDS) {
      await ctx.telegram.sendMessage(adminId, leadText);
    }

    // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    userState[chatId] = null;

    return ctx.reply("–°–ø–∞—Å–∏–±–æ! –Ø –ø–µ—Ä–µ–¥–∞–ª –≤–∞—à—É –∑–∞—è–≤–∫—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É. –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.");
  }

  // –ü–æ–ø—ã—Ç–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
  const dateRegex = /\b(—Å–µ–≥–æ–¥–Ω—è|–∑–∞–≤—Ç—Ä–∞|\d{1,2}\.\d{1,2}|\d{1,2}\s+[–∞-—è]+)\b/i;
  const timeRegex = /\b(\d{1,2}[:.]?\d{0,2}\s*(—É—Ç—Ä–∞|–≤–µ—á–µ—Ä–∞|–¥–Ω—è)?|\b—É—Ç—Ä–æ–º\b|\b–¥–Ω—ë–º\b|\b–≤–µ—á–µ—Ä–æ–º\b)\b/i;

  const foundDate = raw.match(dateRegex);
  const foundTime = raw.match(timeRegex);

  if (foundDate && !state.date) {
    state.date = foundDate[0];
  }

  if (foundTime && !state.time) {
    state.time = foundTime[0];
  }

  // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
  state.context.push(raw);

  try {
    const response = await fetch("https://api.deepseek.com/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${process.env.DEEPSEEK_API_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: "deepseek-chat",
        messages: [
          {
            role: "system",
            content: `
–¢—ã ‚Äî –≤–µ–∂–ª–∏–≤—ã–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏–∏ ¬´–ú–µ–¥–ì–∞—Ä–∞–Ω—Ç¬ª.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –≤–µ—Å—Ç–∏ –¥–∏–∞–ª–æ–≥ —Å –∫–ª–∏–µ–Ω—Ç–æ–º, –ø–æ–º–æ–≥–∞—Ç—å –µ–º—É –∏ —Å–æ–±–∏—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–∏—Å–∏.

–ü–†–ò–í–ï–¢–°–¢–í–ò–ï:
‚Äî –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –∑–∞ –≤–µ—Å—å –¥–∏–∞–ª–æ–≥.
‚Äî –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –Ω–∞–ø–∏—Å–∞–ª ¬´–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ¬ª, ¬´–ø—Ä–∏–≤–µ—Ç¬ª, ¬´–¥–æ–±—Ä—ã–π –¥–µ–Ω—å¬ª, ¬´–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä¬ª, ¬´–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ¬ª ‚Äî –æ—Ç–≤–µ—Ç—å –Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –Ω–æ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑.
‚Äî –ï—Å–ª–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —É–∂–µ –±—ã–ª–æ, –ù–ò–ö–û–ì–î–ê –Ω–µ –Ω–∞—á–∏–Ω–∞–π –æ—Ç–≤–µ—Ç —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è.

–û–ë–©–ò–ï –ü–†–ê–í–ò–õ–ê:
1. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –∫–ª–∏–µ–Ω—Ç –Ω–µ –≥–æ–≤–æ—Ä–∏–ª.
2. –ù–µ –±—É–¥—å —Ñ–∞–º–∏–ª—å—è—Ä–Ω—ã–º.
3. –ù–µ –Ω–∞–∑–Ω–∞—á–∞–π —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –ø—Ä–∏—ë–º–∞.
4. –ù–µ –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ –∑–∞–ø—Ä–æ—Å—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –ø–æ–∫–∞ –Ω–µ —É—Ç–æ—á–Ω–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º–∞, –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è.
5. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ü–µ–Ω—É ‚Äî –Ω–µ –Ω–∞–∑—ã–≤–∞–π —Å—Ç–æ–∏–º–æ—Å—Ç—å –ª–µ—á–µ–Ω–∏—è. –ü—Ä–µ–¥–ª–∞–≥–∞–π –∞–∫—Ü–∏—é.

–ê–ö–¶–ò–Ø:
¬´–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏. –ß—Ç–æ–±—ã –≤—Ä–∞—á —Ç–æ—á–Ω–æ —Å–∫–∞–∑–∞–ª —Ü–µ–Ω—É, –ª—É—á—à–µ –ø—Ä–∏–π—Ç–∏ –Ω–∞ –ø–µ—Ä–≤–∏—á–Ω—ã–π –ø—Ä–∏—ë–º.
–°–µ–π—á–∞—Å –¥–µ–π—Å—Ç–≤—É–µ—Ç –∞–∫—Ü–∏—è: –ü–æ–ª–Ω—ã–π —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π check‚Äëup ‚Äî 3500 —Ä—É–±. –≤–º–µ—Å—Ç–æ 4900 —Ä—É–±.
–í —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤—Ö–æ–¥–∏—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ª—é–±–æ–≥–æ –≤—Ä–∞—á–∞‚Äë—Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∞ –∏ –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–∞—è 3D‚Äë–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–ö–õ–ö–¢).¬ª

–õ–û–ì–ò–ö–ê:
1. –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ (–æ–¥–∏–Ω —Ä–∞–∑).
2. –£—Ç–æ—á–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã.
3. –£—Ç–æ—á–Ω–µ–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–Ω–æ–π –¥–∞—Ç—ã.
4. –£—Ç–æ—á–Ω–µ–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.
5. –ó–∞–ø—Ä–æ—Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
6. –ó–∞–ø—Ä–æ—Å –∏–º–µ–Ω–∏.
7. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ.
            `.trim()
          },
          {
            role: "user",
            content: userMessage
          },
          {
            role: "assistant",
            content: `
–¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
–î–∞—Ç–∞: ${state.date ?? "–Ω–µ —É–∫–∞–∑–∞–Ω–∞"}
–í—Ä–µ–º—è: ${state.time ?? "–Ω–µ —É–∫–∞–∑–∞–Ω–æ"}
            `.trim()
          }
        ]
      })
    });

    const data = await response.json();
    let reply =
      data?.choices?.[0]?.message?.content ??
      "–ò–∑–≤–∏–Ω–∏—Ç–µ, —Å–µ–π—á–∞—Å –Ω–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å.";

    // üî• –†–ê–°–®–ò–†–ï–ù–ù–´–ô –§–ò–õ–¨–¢–† –ü–†–ò–í–ï–¢–°–¢–í–ò–ô
    reply = reply
      .replace(/^–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ[!. ]*/i, "")
      .replace(/^–¥–æ–±—Ä—ã–π –¥–µ–Ω—å[!. ]*/i, "")
      .replace(/^–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä[!. ]*/i, "")
      .replace(/^–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ[!. ]*/i, "")
      .replace(/–≤–∞—Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è ¬´?–º–µ–¥–≥–∞—Ä–∞–Ω—Ç¬ª?/gi, "")
      .replace(/–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ[!. ]*/gi, "")
      .replace(/–¥–æ–±—Ä—ã–π –¥–µ–Ω—å[!. ]*/gi, "")
      .replace(/–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä[!. ]*/gi, "")
      .replace(/–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ[!. ]*/gi, "")
      .trim();

    // üî• –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï –£–¢–û–ß–ù–ï–ù–ò–ô ‚Äî –º–∞–∫—Å–∏–º—É–º 4
    if (reply.match(/—É—Ç–æ—á–Ω–∏—Ç–µ|–ø–æ–¥—Ä–æ–±–Ω–µ–µ|—á—Ç–æ –∏–º–µ–Ω–Ω–æ|–∫–∞–∫–∞—è –∏–º–µ–Ω–Ω–æ/i)) {
      state.clarifyCount++;
    }

    if (state.clarifyCount >= 4) {
      reply =
        "–ß—Ç–æ–±—ã –≤—Ä–∞—á —Ç–æ—á–Ω–æ –æ—Ü–µ–Ω–∏–ª —Å–∏—Ç—É–∞—Ü–∏—é, –ª—É—á—à–µ –ø—Ä–∏–π—Ç–∏ –Ω–∞ –ø–µ—Ä–≤–∏—á–Ω—ã–π –ø—Ä–∏—ë–º. " +
        "–°–µ–π—á–∞—Å –¥–µ–π—Å—Ç–≤—É–µ—Ç –∞–∫—Ü–∏—è: –ø–æ–ª–Ω—ã–π —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π check‚Äëup ‚Äî 3500 —Ä—É–±. –≤–º–µ—Å—Ç–æ 4900 —Ä—É–±. " +
        "–ù–∞–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∫–æ–≥–¥–∞ –≤–∞–º –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–æ —É–¥–æ–±–Ω–æ ‚Äî —Å–µ–≥–æ–¥–Ω—è, –∑–∞–≤—Ç—Ä–∞ –∏–ª–∏ –≤ –¥—Ä—É–≥–æ–π –¥–µ–Ω—å.";
      state.clarifyCount = 0;
    }

    // –ï—Å–ª–∏ –ø–æ—Ä–∞ —Å–æ–±–∏—Ä–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω
    if (
      reply.toLowerCase().includes("–Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞") ||
      (state.date && state.time && !state.phone)
    ) {
      state.waitingForPhone = true;
    }

    await ctx.reply(reply);
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞:", err);
    await ctx.reply("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
  }
});

bot.launch();
